{% extends 'admin/homepageadmin.html.twig' %}

{% block title %}Complaints Management{% endblock %}

{% block body %}
    <div class="container py-5">
        <div class="d-flex flex-column flex-md-row align-items-md-center mb-5">
            <div>
                <h2 class="fw-bold text-dark mb-2">Complaints Management</h2>
                <p class="text-secondary mb-0">Monitor and manage user complaints efficiently</p>
            </div>
        </div>

        {# Flash messages #}
        {% for message in app.flashes('success') %}
            <div class="alert alert-blue alert-dismissible fade show rounded-4 border-0 shadow-sm">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        {% for message in app.flashes('warning') %}
            <div class="alert alert-blue-light alert-dismissible fade show rounded-4 border-0 shadow-sm">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        {% for message in app.flashes('error') %}
            <div class="alert alert-danger alert-dismissible fade show rounded-4 border-0 shadow-sm">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}

        {# Stats Section #}
        <div class="row mb-5 g-4">
            <div class="col-12 col-md-4">
                <div class="p-4 rounded-4 bg-blue-100 h-100 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-blue-600 text-white rounded-circle me-3">
                            <i class="fas fa-inbox fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="text-dark mb-1">Total Complaints</h6>
                            <h3 class="text-dark mb-0">{{ reclamations|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="p-4 rounded-4 bg-blue-50 h-100 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-blue-400 text-white rounded-circle me-3">
                            <i class="fas fa-exclamation-circle fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="text-dark mb-1">Pending Complaints</h6>
                            <h3 class="text-dark mb-0">{{ reclamations|filter(r => r.statut == 'Pending')|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="p-4 rounded-4 bg-blue-200 h-100 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-blue-700 text-white rounded-circle me-3">
                            <i class="fas fa-check-circle fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="text-dark mb-1">Processed Complaints</h6>
                            <h3 class="text-dark mb-0">{{ reclamations|filter(r => r.statut == 'Processed')|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Complaints List #}
        <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0 text-blue-600">Complaints List</h5>
            </div>
            
            <form method="post" action="{{ path('app_admin_reclamation_index') }}" id="reclamationForm">
                <div class="list-group mb-4 rounded-4 overflow-hidden shadow-sm">
                    {% for reclamation in reclamations %}
                        <div class="list-group-item border-0 py-4 px-4 {% if loop.index is odd %}bg-blue-50{% else %}bg-white{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="form-check me-3">
                                    <input type="checkbox" name="selected_reclamations[]" value="{{ reclamation.id }}"
                                           class="reclamation-checkbox form-check-input">
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="fw-bold text-dark mb-0">{{ reclamation.sujet }}</h6>
                                        <span class="badge
                                            {% if reclamation.statut == 'Pending' %}bg-blue-400
                                            {% elseif reclamation.statut == 'Processed' %}bg-blue-600
                                            {% else %}bg-blue-500{% endif %} text-white">
                                            {{ reclamation.statut }}
                                        </span>
                                    </div>
                                    <p class="text-secondary mb-2">
                                        {{ reclamation.description|slice(0, 120) ~ (reclamation.description|length > 120 ? '...' : '') }}
                                    </p>
                                    <div class="d-flex flex-wrap gap-3 text-muted small">
                                        <span><i class="fas fa-user me-1"></i> {{ reclamation.user.nom }} {{ reclamation.user.prenom }}</span>
                                        <span><i class="fas fa-calendar-alt me-1"></i> {{ reclamation.dateCreation|date('d/m/Y H:i') }}</span>
                                    </div>
                                </div>
                                <div class="d-flex gap-2 ms-3">
                                    <button type="button" class="btn btn-sm btn-blue-600 rounded-pill respond-btn"
                                            data-reclamation-id="{{ reclamation.id }}" title="Respond">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger rounded-pill delete-reclamation-btn"
                                            data-reclamation-id="{{ reclamation.id }}"
                                            data-csrf-token="{{ csrf_token('delete_reclamation' ~ reclamation.id) }}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="list-group-item border-0 py-5 text-center text-secondary">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p class="mb-0">No complaints found</p>
                        </div>
                    {% endfor %}
                </div>

                {# Response Form #}
                <div class="mt-5">
                    <h5 class="mb-4 text-blue-600">Respond to Complaints</h5>
                    <div class="bg-white p-4 rounded-4 shadow-sm">
                        {{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}
                            {{ form_errors(form) }}
                            {{ form_row(form.message, {
                                'label': 'Response Message',
                                'attr': {'class': 'form-control rounded-4 border-blue-200', 'rows': 4, 'placeholder': 'Type your response...'},
                                'label_attr': {'class': 'form-label fw-semibold text-dark'}
                            }) }}
                            {{ form_row(form.submit, {
                                'label': 'Send Response',
                                'attr': {'class': 'btn btn-blue-600 rounded-pill mt-3'}
                            }) }}
                        {{ form_end(form) }}
                    </div>
                </div>
            </form>
        </div>

        {# Responses List #}
        <div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0 text-blue-600">Sent Responses</h5>
                <div>
                    <button type="button" class="btn btn-outline-blue-600 rounded-pill me-2" id="selectAllResponses">
                        <i class="fas fa-check me-1"></i> Select All
                    </button>
                    <button type="button" class="btn btn-outline-danger rounded-pill" id="deleteSelectedResponses" title="Delete Selected">
                        <i class="fas fa-trash me-1"></i> Delete Selected
                    </button>
                </div>
            </div>
            
            <form method="post" action="{{ path('app_admin_reponse_delete') }}" id="deleteResponsesForm">
                <div class="list-group rounded-4 overflow-hidden shadow-sm">
                    {% for reponse in reponses %}
                        <div class="list-group-item border-0 py-4 px-4 {% if loop.index is odd %}bg-blue-50{% else %}bg-white{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="form-check me-3">
                                    <input type="checkbox" name="selected_reponses[]" value="{{ reponse.id }}"
                                           class="reponse-checkbox form-check-input">
                                </div>
                                <div class="flex-grow-1">
                                    <p class="text-secondary mb-2">
                                        {{ reponse.message|slice(0, 120) ~ (reponse.message|length > 120 ? '...' : '') }}
                                    </p>
                                    <div class="d-flex flex-wrap gap-3 text-muted small">
                                        <span><i class="fas fa-user me-1"></i> {{ reponse.admin.nom }} {{ reponse.admin.prenom }}</span>
                                        <span><i class="fas fa-calendar-alt me-1"></i> {{ reponse.dateReponse|date('d/m/Y H:i') }}</span>
                                        <span><i class="fas fa-link me-1"></i> {{ reponse.reclamation.sujet|slice(0, 25) ~ (reponse.reclamation.sujet|length > 25 ? '...' : '') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="list-group-item border-0 py-5 text-center text-secondary">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p class="mb-0">No responses found</p>
                        </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="_token" value="{{ csrf_token('delete_reponses') }}">
            </form>
        </div>

        {# Delete Confirmation Modal for Complaints #}
        <div class="modal fade" id="deleteReclamationModal" tabindex="-1" aria-labelledby="deleteReclamationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content rounded-4 border-0 shadow-sm">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-semibold text-blue-600" id="deleteReclamationModalLabel">Confirm Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this complaint? This action cannot be undone.
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-outline-blue-600 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                        <form id="deleteReclamationForm" method="POST" action="">
                            <input type="hidden" name="_token" value="">
                            <button type="submit" class="btn btn-danger rounded-pill">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# Delete Confirmation Modal for Responses #}
        <div class="modal fade" id="deleteResponsesModal" tabindex="-1" aria-labelledby="deleteResponsesModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content rounded-4 border-0 shadow-sm">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-semibold text-blue-600" id="deleteResponsesModalLabel">Confirm Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete the selected responses? This action cannot be undone.
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-outline-blue-600 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger rounded-pill" form="deleteResponsesForm">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        body {
            background-color: #f5f7fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
        }
        .container {
            max-width: 1400px;
        }
        .rounded-4 {
            border-radius: 1rem !important;
        }
        .text-dark {
            color: #1a202c !important;
        }
        .text-secondary {
            color: #6b7280 !important;
        }
        .text-blue-600 {
            color: #2563eb !important;
        }
        .bg-blue-50 {
            background-color: #dbeafe !important;
        }
        .bg-blue-100 {
            background-color: #bfdbfe !important;
        }
        .bg-blue-200 {
            background-color: #93c5fd !important;
        }
        .bg-blue-400 {
            background-color: #60a5fa !important;
        }
        .bg-blue-500 {
            background-color: #3b82f6 !important;
        }
        .bg-blue-600 {
            background-color: #2563eb !important;
        }
        .bg-blue-700 {
            background-color: #1d4ed8 !important;
        }
        .border-blue-200 {
            border-color: #93c5fd !important;
        }
        .btn-blue-600 {
            background-color: #2563eb;
            border-color: #2563eb;
            color: #ffffff;
        }
        .btn-blue-600:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .btn-outline-blue-600 {
            border-color: #2563eb;
            color: #2563eb;
        }
        .btn-outline-blue-600:hover {
            background-color: #dbeafe;
            border-color: #2563eb;
        }
        .alert-blue {
            background-color: #bfdbfe;
            color: #1e40af;
            border-color: #93c5fd;
        }
        .alert-blue-light {
            background-color: #dbeafe;
            color: #1e40af;
            border-color: #bfdbfe;
        }
        .icon-shape {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn {
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
        }
        .form-control {
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            box-shadow: none;
            transition: border-color 0.2s ease;
        }
        .form-control:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .form-check-input {
            border-radius: 4px;
            cursor: pointer;
        }
        .badge {
            font-size: 0.75rem;
            padding: 0.4em 0.8em;
            border-radius: 0.5rem;
        }
        .alert {
            border-radius: 1rem;
        }
        .modal-content {
            border-radius: 1rem;
        }
        .list-group-item {
            transition: background-color 0.2s ease;
        }
        .list-group-item:hover {
            background-color: #dbeafe !important;
        }
        h2 {
            font-size: 2rem;
        }
        h5 {
            font-size: 1.25rem;
        }
        h6 {
            font-size: 1rem;
        }
        @media (max-width: 576px) {
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            .list-group-item {
                padding: 1rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            h5 {
                font-size: 1rem;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enable tooltips
            document.querySelectorAll('[title]').forEach(el => new bootstrap.Tooltip(el));

            // Select all responses
            document.getElementById('selectAllResponses')?.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.reponse-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
            });

            // Delete confirmation modal for complaints
            const deleteReclamationModal = new bootstrap.Modal(document.getElementById('deleteReclamationModal'));
            document.querySelectorAll('.delete-reclamation-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reclamationId = this.getAttribute('data-reclamation-id');
                    const csrfToken = this.getAttribute('data-csrf-token');
                    const deleteReclamationForm = document.getElementById('deleteReclamationForm');
                    deleteReclamationForm.action = `/admin/reclamation/${reclamationId}/delete`;
                    deleteReclamationForm.querySelector('input[name="_token"]').value = csrfToken;
                    deleteReclamationModal.show();
                });
            });

            // Delete confirmation modal for responses
            const deleteResponsesModal = new bootstrap.Modal(document.getElementById('deleteResponsesModal'));
            document.getElementById('deleteSelectedResponses')?.addEventListener('click', function(e) {
                e.preventDefault();
                const checked = document.querySelectorAll('input[name="selected_reponses[]"]:checked').length;
                if (checked === 0) {
                    alert('Please select at least one response to delete.');
                    return;
                }
                deleteResponsesModal.show();
            });

            // Respond button to select single reclamation
            document.querySelectorAll('.respond-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reclamationId = this.getAttribute('data-reclamation-id');
                    document.querySelectorAll('.reclamation-checkbox').forEach(cb => {
                        cb.checked = cb.value === reclamationId;
                    });
                    document.querySelector('#reclamationForm').scrollIntoView({ behavior: 'smooth' });
                });
            });

            // Form submission validation
            document.getElementById('reclamationForm').addEventListener('submit', function(e) {
                const checked = document.querySelectorAll('input[name="selected_reclamations[]"]:checked').length;
                if (checked === 0) {
                    e.preventDefault();
                    alert('Please select at least one complaint.');
                }
            });
        });
    </script>
{% endblock %}