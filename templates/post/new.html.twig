{% extends 'sportifdashboard/homepagesportif.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.ckeditor.com/4.21.0/standard/ckeditor.js"></script>
    <style>
        input.parsley-error,
        select.parsley-error,
        textarea.parsley-error {
            border-color: #ff0000 !important;
        }
        input.parsley-success,
        select.parsley-success,
        textarea.parsley-success {
            border-color: #00cc00 !important;
        }
        .parsley-errors-list {
            margin: 2px 0 0;
            padding: 0;
            list-style: none;
            color: #ff0000;
            font-size: 0.9em;
        }
        .dropzone {
            border: 2px dashed #007bff;
            padding: 30px;
            background: #f9f9f9;
            text-align: center;
            cursor: pointer;
        }
        .dropzone .dz-message {
            font-weight: bold;
            color: #555;
        }
        .dropzone .dz-preview .dz-image img {
            width: 200px;
            height: auto;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="mb-4">Créer un nouveau post</h1>

    {{ form_start(form, {'attr': {'data-parsley-validate': '', 'enctype': 'multipart/form-data'}}) }}

    <div class="mb-3">
        {{ form_label(form.title, 'Titre', {'label_attr': {'class': 'form-label'}}) }}
        {{ form_widget(form.title, {
            'attr': {
                'class': 'form-control',
                'data-parsley-trigger': 'keyup',
                'data-parsley-minlength': '3',
                'data-parsley-minlength-message': 'Le titre doit contenir au moins 3 caractères.'
            }
        }) }}
        <div class="text-danger">{{ form_errors(form.title) }}</div>
    </div>

    <div class="mb-3">
        {{ form_label(form.content, 'Contenu', {'label_attr': {'class': 'form-label'}}) }}
        {{ form_widget(form.content, {
            'attr': {
                'class': 'form-control',
                'id': 'post_content',
                'data-parsley-trigger': 'keyup',
                'data-parsley-cleancontent': '',
                'data-parsley-forbiddenwords': ''
            }
        }) }}
        <div class="text-danger">{{ form_errors(form.content) }}</div>
    </div>

    <div class="mb-3">
        {{ form_label(form.webImage, "URL de l'image (optionnel)", {'label_attr': {'class': 'form-label'}}) }}
        {{ form_widget(form.webImage, {'attr': {'class': 'form-control', 'placeholder': "Entrez une URL"}}) }}
        <div class="text-danger">{{ form_errors(form.webImage) }}</div>
    </div>

    <div class="mb-3">
        <p class="text-center">Ou téléchargez une image locale :</p>
        <label class="form-label">Télécharger une image</label>
        <div id="dropzone" class="dropzone">
            <div class="dz-message">Glissez-déposez une image ici ou cliquez</div>
        </div>
    </div>

    <div style="display:none">
        {{ form_row(form.imageFile) }}
    </div>

    <button type="submit" class="btn btn-primary">Publier</button>
    {{ form_end(form) }}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/parsley.js/2.9.2/parsley.min.js" crossorigin="anonymous"></script>

    <script>
        Dropzone.autoDiscover = false;
        const myDropzone = new Dropzone("#dropzone", {
            url: "#",
            autoProcessQueue: false,
            clickable: "#dropzone",
            maxFiles: 1,
            acceptedFiles: 'image/*',
            addRemoveLinks: true,
        });

        const webImageInput = document.querySelector('input[name="post[webImage]"]');
        const fileInput = document.querySelector('input[name="post[imageFile]"]');
        const formElt = document.querySelector('form[data-parsley-validate]');

        // CKEditor init
        const editor = CKEDITOR.replace('post_content', {
            allowedContent: true,
            removePlugins: 'elementspath',
            height: 300,
            on: {
                change: function() {
                    this.updateElement();
                    $('#post_content').trigger('input');
                }
            }
        });

        // Parsley custom validator for clean content length
        window.Parsley.addValidator('cleancontent', {
            validateString: function(value) {
                const html = editor.getData();
                const text = html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                return text.length >= 10;
            },
            messages: { fr: 'Le contenu doit contenir au moins 10 caractères (sans HTML).' }
        });

        // Parsley validator for forbidden words
        window.Parsley.addValidator('forbiddenwords', {
            validateString: function(value) {
                const html = editor.getData();
                const text = html.replace(/<[^>]*>/g, ' ').toLowerCase();
                const forbidden = ['spam', 'arnaque', 'insulte'];
                return !forbidden.some(word => text.includes(word));
            },
            messages: { fr: 'Le contenu contient des mots interdits.' }
        });

        // Si l'utilisateur tape une URL, on désactive Dropzone
        webImageInput.addEventListener('input', function () {
            if (this.value.trim() !== '') {
                if (myDropzone.files.length) {
                    myDropzone.removeAllFiles(true);
                }
                myDropzone.disable();
            } else {
                myDropzone.enable();
            }
        });

        // Lorsqu’un fichier est ajouté
        myDropzone.on("addedfile", function(file) {
            if (webImageInput.value.trim() !== '') {
                this.removeFile(file);
                alert('Vous avez déjà saisi une URL. Choisissez soit un fichier, soit une URL.');
                return;
            }
            webImageInput.value = '';
            webImageInput.readOnly = true;

            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
        });

        // Lorsqu’un fichier est retiré
        myDropzone.on("removedfile", function() {
            fileInput.value = "";
            webImageInput.readOnly = false;
        });

        // Vérification avant envoi
        formElt.addEventListener('submit', function(e) {
            editor.updateElement();

            const html = editor.getData();
            const text = html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();

            if (text.length < 10) {
                e.preventDefault();
                $('#post_content').parsley().reset().validate();
                return;
            }

            if (webImageInput.value.trim() !== '' && fileInput.files.length) {
                e.preventDefault();
                alert('Veuillez choisir soit une URL, soit un fichier, pas les deux.');
            }
        });
    </script>
{% endblock %}
