{% extends 'sportifdashboard/homepagesportif.html.twig' %}

{% block title %}Posts{% endblock %}

{% block stylesheet %}
<link rel="stylesheet" href="{{ asset('css/post-style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    .comment-actions {
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.2s ease;
        display: inline-flex !important;
        gap: 12px;
        align-items: center;
        position: absolute !important;
        right: 10px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        z-index: 100 !important;
    }

    .comment-container:hover .comment-actions {
        opacity: 1 !important;
    }

    .btn-icon {
        padding: 8px !important;
        border-radius: 50% !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
        border: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        width: 36px !important;
        height: 36px !important;
    }

    .btn-icon:hover {
        transform: translateY(-3px) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.25) !important;
    }

    /* Couleurs et styles pour les icônes */
    .btn-icon.edit {
        background-color: #2196F3 !important;
    }
    
    .btn-icon.edit i {
        color: white !important;
        font-size: 1rem !important;
    }

    .btn-icon.delete {
        background-color: #dc3545 !important;
    }

    .btn-icon.delete i {
        color: white !important;
        font-size: 1rem !important;
    }

    /* Effets de survol améliorés */
    .btn-icon.edit:hover {
        background-color: #0d8bf2 !important;
    }

    .btn-icon.delete:hover {
        background-color: #c82333 !important;
    }

    /* Style pour les tooltips */
    [data-tooltip] {
        position: relative !important;
    }

    [data-tooltip]:before {
        content: attr(data-tooltip);
        position: absolute !important;
        bottom: 120% !important;
        left: 50% !important;
        transform: translateX(-50%) translateY(-5px) !important;
        padding: 6px 12px !important;
        background: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        font-size: 12px !important;
        font-weight: 500 !important;
        white-space: nowrap !important;
        border-radius: 4px !important;
        opacity: 0 !important;
        visibility: hidden !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
        z-index: 100 !important;
    }

    [data-tooltip]:hover:before {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateX(-50%) translateY(-10px) !important;
    }
    
    /* Style pour les boutons d'action du post */
    .post-buttons-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 10px;
        width: 100%;
    }
    
    .btn-post-action {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 16px;
        transition: all 0.2s ease;
        flex: 1;
        min-width: fit-content;
        max-width: 110px;
    }
    
    .btn-post-action i {
        margin-right: 0;
        font-size: 18px;
    }
    
    .btn-post-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Styles pour Responsive */
    @media (max-width: 576px) {
        .btn-post-action {
            padding: 6px 10px;
            font-size: 14px;
        }
        
        .btn-post-action i {
            font-size: 16px;
        }
    }
</style>
{% endblock %}




{% block body %}
<div class="breadcrumb-container mb-4">
  <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
    <ol class="breadcrumb bg-light p-2 rounded">
      <li class="breadcrumb-item"><a href="{{ path('app_sportifdashboard') }}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ path('app_sportif_blogs') }}">Blogs</a></li>
      <li class="breadcrumb-item active" aria-current="page">Liste des posts</li>
    </ol>
  </nav>
</div>

<h1 class="mb-4">Posts</h1>
<div class="d-flex justify-content-end gap-3 mb-4">
  <a href="{{ path('app_post_new') }}" id="create-post-btn" class="btn btn-success">Créer un article</a>
  <button id="show-filters-btn" class="btn btn-primary">Filtrer les articles</button>
</div>

{# Formulaire de filtrage - initialement caché #}
<div id="filter-form-container" class="card shadow-sm mb-4" style="display: none;">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">Filtrer les articles</h5>
    <button id="close-filters-btn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-times"></i></button>
  </div>
  <div class="card-body">
    {{ form_start(filter_form) }}
    <div class="row">
      <div class="col-md-4 mb-3">
        {{ form_row(filter_form.search) }}
      </div>
      <div class="col-md-4 mb-3">
        {{ form_row(filter_form.author) }}
      </div>
      <div class="col-md-4 mb-3">
        {{ form_row(filter_form.sortBy) }}
      </div>
    </div>
    <div class="row">
      <div class="col-md-3 mb-3">
        {{ form_row(filter_form.dateFrom) }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form_row(filter_form.dateTo) }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form_row(filter_form.minReactions) }}
      </div>
      <div class="col-md-3 mb-3">
        {{ form_row(filter_form.minComments) }}
      </div>
    </div>
    <div class="row">
      <div class="col-md-3 mb-3">
        {{ form_row(filter_form.itemsPerPage) }}
      </div>
      <div class="col-md-3 mb-3 ms-auto">
        <div class="d-flex gap-2">
          <a href="{{ path('app_post_index') }}" class="btn btn-secondary w-50">Réinitialiser</a>
          {{ form_widget(filter_form.filter, {'attr': {'class': 'btn btn-primary w-50'}}) }}
        </div>
      </div>
    </div>
    {{ form_end(filter_form) }}
  </div>
</div>

{# Résumé des filtres actifs #}
{% set active_filters = [] %}
{% if app.request.query.get('search') %}
  {% set active_filters = active_filters|merge(['Recherche: ' ~ app.request.query.get('search')]) %}
{% endif %}
{% if app.request.query.get('author') %}
  {% set author = filter_form.author.vars.choices|filter(choice => choice.value == app.request.query.get('author'))|first %}
  {% if author is defined %}
    {% set active_filters = active_filters|merge(['Auteur: ' ~ author.label]) %}
  {% endif %}
{% endif %}
{% if app.request.query.get('dateFrom') %}
  {% set active_filters = active_filters|merge(['Date (début): ' ~ app.request.query.get('dateFrom')]) %}
{% endif %}
{% if app.request.query.get('dateTo') %}
  {% set active_filters = active_filters|merge(['Date (fin): ' ~ app.request.query.get('dateTo')]) %}
{% endif %}
{% if app.request.query.get('minReactions') %}
  {% set active_filters = active_filters|merge(['Min. réactions: ' ~ app.request.query.get('minReactions')]) %}
{% endif %}
{% if app.request.query.get('minComments') %}
  {% set active_filters = active_filters|merge(['Min. commentaires: ' ~ app.request.query.get('minComments')]) %}
{% endif %}
{% if app.request.query.get('itemsPerPage') %}
  {% set active_filters = active_filters|merge(['Articles par page: ' ~ app.request.query.get('itemsPerPage')]) %}
{% endif %}
{% if app.request.query.get('sortBy') %}
  {% set sort_labels = {
    'date_desc': 'Date (plus récent)', 
    'date_asc': 'Date (plus ancien)', 
    'reactions': 'Nombre de réactions', 
    'comments': 'Nombre de commentaires'
  } %}
  {% set active_filters = active_filters|merge(['Tri: ' ~ sort_labels[app.request.query.get('sortBy')]]) %}
{% endif %}

{% if active_filters|length > 0 %}
  <div class="alert alert-info mb-4">
    <h6 class="mb-2"><i class="fas fa-filter me-2"></i>Filtres actifs:</h6>
    <div class="d-flex gap-2 flex-wrap">
      {% for filter in active_filters %}
        <span class="badge bg-primary">{{ filter }}</span>
      {% endfor %}
    </div>
  </div>
{% endif %}

<div class="container">
  {# Compteur de résultats #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <span class="text-muted">
        {% if active_filters|length > 0 %}
          {{ posts.getTotalItemCount }} résultat{{ posts.getTotalItemCount > 1 ? 's' : '' }} trouvé{{ posts.getTotalItemCount > 1 ? 's' : '' }}
        {% else %}
          {{ posts.getTotalItemCount }} article{{ posts.getTotalItemCount > 1 ? 's' : '' }}
        {% endif %}
      </span>
    </div>
  </div>
  
  <div class="row">
    {% for post in posts %}
      <div class="col-12 col-md-6 mb-4">
        <div class="card card-post card-round h-100">
          {% if post.imageUrl %}
            <img class="card-img-top" src="{{ asset(post.webPath) }}" alt="Image du post {{ post.title }}" />
          {% endif %}
          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-center mb-2">
              <img src="{{ post.user.imageUrl ? asset(post.user.imageUrl) : asset('img/screen/user.png') }}" alt="Avatar de {{ post.user.nom }}" class="avatar-img rounded-circle" style="width:40px; height:40px; object-fit:cover;">
              <div class="ms-2">
                <p class="username mb-0">{{ post.user.nom }}</p>
                <p class="date text-muted mb-0">{{ post.createdAt ? post.createdAt|date('d M Y') : '—' }}</p>
              </div>
            </div>
            <div class="separator-solid mb-2"></div>
            <h5 class="card-title">
              <a href="{{ path('app_post_show',{id:post.id}) }}">{{ post.title }}</a>
            </h5>
            <p class="card-text flex-grow-1">{{ post.content|raw }}</p>

            <div class="post-actions-container">
                {# Removing the reactions summary display here #}
                {# End of removed section #}
            </div>

            <div class="post-buttons-container">
              <button type="button" class="btn btn-info btn-post-action" data-bs-toggle="modal" data-bs-target="#commentsModal{{ post.id }}">
                <i class="far fa-comment-alt"></i><span class="comment-count">{{ post.comments|length }}</span>
              </button>
              
              <a href="{{ path('app_post_show',{id:post.id}) }}" class="btn btn-primary btn-post-action">
                <i class="fas fa-eye"></i>
              </a>
              
              <button class="btn btn-secondary btn-post-action btn-react-toggle{% if post.userReaction(app.user) %} active{% endif %}" 
                      data-post-id="{{ post.id }}" 
                      data-csrf-token="{{ csrf_token('reaction' ~ post.id) }}">
                {% set userReaction = post.userReaction(app.user) %}
                {% set reactionCounts = post.getReactionsCountByType() %}
                {% set totalReactions = 0 %}
                {% for count in reactionCounts %}
                    {% set totalReactions = totalReactions + count %}
                {% endfor %}
                
                {% if userReaction %}
                  <span class="reaction-{{ userReaction }}">
                    {{ reactionTypes[userReaction] }}
                  </span>
                {% else %}
                  <i class="far fa-thumbs-up"></i>
                {% endif %}
                <span class="reaction-count ms-1">{{ totalReactions }}</span>
              </button>
              
              {% if post.user == app.user %}
                <a href="{{ path('app_post_edit',{id:post.id}) }}" class="btn btn-secondary btn-post-action">
                  <i class="fas fa-edit"></i>
                </a>
                <button type="button" class="btn btn-danger btn-post-action" data-bs-toggle="modal" data-bs-target="#deletePostModal{{ post.id }}">
                  <i class="fas fa-trash-alt"></i>
                </button>
              {% endif %}
              
              <div class="reaction-bar d-none">
                {% for type, emoji in reactionTypes %}
                  <span class="react-option" data-type="{{ type }}" data-reaction="{{ type|capitalize }}">
                    {{ emoji }}
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        {# Modal commentaires #}
        <div class="modal fade" id="commentsModal{{ post.id }}" tabindex="-1" aria-labelledby="commentsModalLabel{{ post.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content" style="border-radius:10px;overflow:hidden;">
              <div class="modal-body p-0 d-flex" style="height:80vh;">

                <div class="col-md-7 d-none d-md-block bg-dark">
                  {% if post.imageUrl %}
                    <img src="{{ asset(post.webPath) }}" class="w-100 h-100" style="object-fit:cover;" alt="Post image">
                  {% else %}
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center text-white">Pas d'image</div>
                  {% endif %}
                </div>

                <div class="col-md-5 d-flex flex-column bg-white">

                  <div class="d-flex align-items-center p-3 border-bottom">
                    <img src="{{ post.user.imageUrl ? asset(post.user.imageUrl) : asset('img/screen/user.png') }}" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover;">
                    <strong>{{ post.user.nom }}</strong>
                  </div>
                  <div class="p-3 border-bottom">
                    <h5>{{ post.title }}</h5>
                    <p class="mb-1">{{ post.content|raw }}</p>
                    <small class="text-muted">{{ post.createdAt ? post.createdAt|date('d M Y à H:i') : '—' }}</small>
                  </div>
                  <div class="flex-grow-1 overflow-auto p-3" style="min-height:0;">
                    {% if post.comments|length > 0 %}
                      {% for comment in post.comments|sort((a, b) => a.createdAt <=> b.createdAt) %}
                      <div class="d-flex align-items-start mb-3">
                        <img src="{{ comment.user.imageUrl ? asset(comment.user.imageUrl) : asset('img/screen/user.png') }}" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover;">
                        <div class="comment-container w-100 position-relative">
                          <strong>{{ comment.user.nom }}</strong>
                          <p class="comment-content mb-1">{{ comment.content }}</p>
                          <small class="text-muted">{{ comment.createdAt|date('d M Y à H:i') }}</small>
                          {% if comment.user == app.user %}
                            <div class="comment-actions">
                                <button class="btn-icon edit js-edit-comment-btn" 
                                        data-comment-id="{{ comment.id }}"
                                        data-token="{{ csrf_token('edit-comment' ~ comment.id) }}"
                                        data-tooltip="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form action="{{ path('app_comment_delete', {id: comment.id}) }}" 
                                      method="post" 
                                      class="js-delete-comment-form d-inline" 
                                      data-post-id="{{ post.id }}">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comment.id) }}">
                                    <button type="submit" class="btn-icon delete" data-tooltip="Supprimer">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                    {% else %}
                      <p class="text-center text-muted">Aucun commentaire.</p>
                    {% endif %}
                  </div>
                  <div class="border-top p-3 d-flex align-items-center">
                    <img src="{{ app.user.imageUrl ? asset(app.user.imageUrl) : asset('img/screen/user.png') }}" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover;">
                   
                   
                    <div id="comment-errors-{{ post.id }}" class="text-danger mb-2" style="display: none;"></div>


                    



                    <form 
    action="{{ path('app_comment_new',{postId:post.id}) }}" 
    method="post" 
    class="js-add-comment-form w-100 d-flex" 
    data-post-id="{{ post.id }}"
>
    {# champ CSRF obligatoire #}
    <input type="hidden" name="_token" 
           value="{{ csrf_token('comment' ~ post.id) }}">
    <input 
        type="text" 
        name="content" 
        class="form-control me-2 border-0 bg-light" 
        placeholder="Ajouter un commentaire..." 
        required
    >
    <button type="submit" class="btn btn-primary">
        Ajouter
    </button>
</form>




                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        {# Modal suppression du post #}
        {% if post.user == app.user %}
        <div class="modal fade" id="deletePostModal{{ post.id }}" tabindex="-1" aria-labelledby="deletePostLabel{{ post.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
              <div class="modal-header border-0 justify-content-center">
                <h5 class="modal-title" id="deletePostLabel{{ post.id }}"><i class="fas fa-trash-alt fa-3x text-danger"></i></h5>
              </div>
              <div class="modal-body">
                <p>Es-tu sûr(e) de vouloir supprimer ce post :</p>
                <p><strong>{{ post.title }}</strong> ?</p>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form action="{{ path('app_post_delete',{id:post.id}) }}" method="post" class="js-delete-post-form d-inline">
                  <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ post.id) }}">
                  <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

      </div>
    {% else %}
      <div class="col-12"><p class="text-center text-muted">Aucun post trouvé.</p></div>
    {% endfor %}
  </div>
  
  <!-- Pagination -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="navigation d-flex justify-content-center">
        {{ knp_pagination_render(posts) }}
      </div>
    </div>
  </div>
</div>
{% endblock %}





{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cacher le formulaire de filtre au chargement de la page
    const filterFormContainer = document.getElementById('filter-form-container');
    const showFiltersBtn = document.getElementById('show-filters-btn');
    const closeFiltersBtn = document.getElementById('close-filters-btn');
    
    filterFormContainer.style.display = 'none';
    
    // Ajouter un événement de clic sur le bouton pour afficher/masquer le formulaire
    showFiltersBtn.addEventListener('click', function() {
        if (filterFormContainer.style.display === 'none') {
            filterFormContainer.style.display = 'block';
            this.textContent = 'Masquer les filtres';
            filterFormContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            filterFormContainer.style.display = 'none';
            this.textContent = 'Filtrer les articles';
        }
    });
    
    // Vérifier si des filtres sont actifs pour afficher le formulaire
    const activeFilters = document.querySelectorAll('.badge.bg-primary');
    if (activeFilters.length > 0) {
        filterFormContainer.style.display = 'block';
        showFiltersBtn.textContent = 'Masquer les filtres';
    }
    
    // Masquer le formulaire lorsque l'utilisateur clique sur le bouton de fermeture
    if (closeFiltersBtn) {
        closeFiltersBtn.addEventListener('click', function() {
            filterFormContainer.style.display = 'none';
            showFiltersBtn.textContent = 'Filtrer les articles';
        });
    }

    // Appliquer les styles manuellement pour contourner les problèmes de cache CSS
    document.querySelectorAll('.comment-actions').forEach(el => {
        el.style.opacity = "0";
        el.style.display = "inline-flex";
        el.style.gap = "12px";
        el.style.position = "absolute";
        el.style.right = "10px";
        el.style.top = "50%";
        el.style.transform = "translateY(-50%)";
        el.style.zIndex = "100";
    });
    
    document.querySelectorAll('.btn-icon.edit').forEach(el => {
        el.style.backgroundColor = "#2196F3";
        el.style.padding = "8px";
        el.style.borderRadius = "50%";
        el.style.boxShadow = "0 2px 5px rgba(0,0,0,0.2)";
        el.style.border = "none";
        el.style.display = "flex";
        el.style.alignItems = "center";
        el.style.justifyContent = "center";
        el.style.width = "36px";
        el.style.height = "36px";
        el.querySelector('i').style.color = "white";
    });
    
    document.querySelectorAll('.btn-icon.delete').forEach(el => {
        el.style.backgroundColor = "#dc3545";
        el.style.padding = "8px";
        el.style.borderRadius = "50%";
        el.style.boxShadow = "0 2px 5px rgba(0,0,0,0.2)";
        el.style.border = "none";
        el.style.display = "flex";
        el.style.alignItems = "center";
        el.style.justifyContent = "center";
        el.style.width = "36px";
        el.style.height = "36px";
        el.querySelector('i').style.color = "white";
    });
    
    // Ajout d'événements hover pour les conteneurs de commentaires
    document.querySelectorAll('.comment-container').forEach(container => {
        container.addEventListener('mouseenter', function() {
            const actions = this.querySelector('.comment-actions');
            if (actions) actions.style.opacity = "1";
        });
        
        container.addEventListener('mouseleave', function() {
            const actions = this.querySelector('.comment-actions');
            if (actions) actions.style.opacity = "0";
        });
    });

    // Fonction pour créer une alerte stylisée
    function createAlert(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        return alertDiv;
    }

    // Fonction pour afficher une alerte
    function showAlert(message, type = 'success', container) {
        const alert = createAlert(message, type);
        container.insertAdjacentElement('afterbegin', alert);
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }, 3000);
    }

    // Fonction pour mettre à jour la date dans le DOM
    function updateDateTime(element, newDateTime) {
        const dateElement = element.querySelector('.text-muted');
        if (dateElement) {
            dateElement.textContent = newDateTime;
        }
    }

    // Fonction pour créer un élément de commentaire
    function createCommentElement(data, postId) {
        const div = document.createElement('div');
        div.className = 'd-flex align-items-start mb-3';
        div.innerHTML = `
            <img src="${data.user.avatar}" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover;">
            <div class="comment-container w-100 position-relative">
                <strong>${data.user.nom}</strong>
                <p class="comment-content mb-1">${data.content}</p>
                <small class="text-muted">${data.createdAt}</small>
                <div class="comment-actions">
                    <button class="btn-icon edit js-edit-comment-btn" 
                            data-comment-id="${data.id}" 
                            data-token="${data.tokens.edit}"
                            data-tooltip="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <form action="/comment/delete/${data.id}" method="post" 
                          class="js-delete-comment-form d-inline" 
                          data-post-id="${postId}">
                        <input type="hidden" name="_token" value="${data.tokens.delete}">
                        <button type="submit" class="btn-icon delete" data-tooltip="Supprimer">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </div>
            </div>
        `;
        
        // Appliquer directement les styles aux nouveaux éléments créés
        setTimeout(() => {
            const actionsDiv = div.querySelector('.comment-actions');
            if (actionsDiv) {
                actionsDiv.style.opacity = "0";
                actionsDiv.style.display = "inline-flex";
                actionsDiv.style.gap = "12px";
                actionsDiv.style.position = "absolute";
                actionsDiv.style.right = "10px";
                actionsDiv.style.top = "50%";
                actionsDiv.style.transform = "translateY(-50%)";
                actionsDiv.style.zIndex = "100";
            }
            
            const editBtn = div.querySelector('.btn-icon.edit');
            if (editBtn) {
                editBtn.style.backgroundColor = "#2196F3";
                editBtn.style.padding = "8px";
                editBtn.style.borderRadius = "50%";
                editBtn.style.boxShadow = "0 2px 5px rgba(0,0,0,0.2)";
                editBtn.style.border = "none";
                editBtn.style.display = "flex";
                editBtn.style.alignItems = "center";
                editBtn.style.justifyContent = "center";
                editBtn.style.width = "36px";
                editBtn.style.height = "36px";
                editBtn.querySelector('i').style.color = "white";
            }
            
            const deleteBtn = div.querySelector('.btn-icon.delete');
            if (deleteBtn) {
                deleteBtn.style.backgroundColor = "#dc3545";
                deleteBtn.style.padding = "8px";
                deleteBtn.style.borderRadius = "50%";
                deleteBtn.style.boxShadow = "0 2px 5px rgba(0,0,0,0.2)";
                deleteBtn.style.border = "none";
                deleteBtn.style.display = "flex";
                deleteBtn.style.alignItems = "center";
                deleteBtn.style.justifyContent = "center";
                deleteBtn.style.width = "36px";
                deleteBtn.style.height = "36px";
                deleteBtn.querySelector('i').style.color = "white";
            }
            
            // Ajouter les événements hover
            const container = div.querySelector('.comment-container');
            if (container) {
                container.addEventListener('mouseenter', function() {
                    const actions = this.querySelector('.comment-actions');
                    if (actions) actions.style.opacity = "1";
                });
                
                container.addEventListener('mouseleave', function() {
                    const actions = this.querySelector('.comment-actions');
                    if (actions) actions.style.opacity = "0";
                });
            }
            
            // Réattacher les événements aux nouveaux boutons
            const newEditBtn = div.querySelector('.js-edit-comment-btn');
            if (newEditBtn) {
                attachEditButtonEvents(newEditBtn);
            }
            
            const newDeleteForm = div.querySelector('.js-delete-comment-form');
            if (newDeleteForm) {
                attachDeleteFormEvents(newDeleteForm);
            }
        }, 50);
        
        return div;
    }
    
    // Fonction pour attacher les événements au bouton d'édition
    function attachEditButtonEvents(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const commentContainer = this.closest('.comment-container');
            const commentContent = commentContainer.querySelector('.comment-content');
            const commentText = commentContent.textContent.trim();
            const actionsDiv = commentContainer.querySelector('.comment-actions');
            
            // Masquer les boutons d'action pendant l'édition
            if (actionsDiv) {
                actionsDiv.style.display = 'none';
            }
            
            const editForm = document.createElement('form');
            editForm.className = 'edit-comment-form mt-2';
            editForm.style.position = 'relative';
            editForm.style.zIndex = '200';
            editForm.style.width = '100%';
            editForm.style.marginTop = '0 !important';
            editForm.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control" value="${commentText.replace(/"/g, '&quot;')}" required>
                    <button type="submit" class="btn btn-primary btn-sm">Enregistrer</button>
                    <button type="button" class="btn btn-secondary btn-sm cancel-edit">Annuler</button>
                </div>
            `;

            commentContent.style.display = 'none';
            commentContent.insertAdjacentElement('afterend', editForm);

            // Focus sur l'input
            setTimeout(() => {
                const input = editForm.querySelector('input');
                if (input) {
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);
                }
            }, 10);

            editForm.querySelector('.cancel-edit').addEventListener('click', () => {
                editForm.remove();
                commentContent.style.display = '';
                // Réafficher les boutons d'action quand on annule
                if (actionsDiv) {
                    actionsDiv.style.display = 'inline-flex';
                }
            });

            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const newContent = this.querySelector('input').value.trim();
                const commentId = btn.dataset.commentId;
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;

                try {
                    const response = await fetch(`/comment/${commentId}/edit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            content: newContent,
                            _token: btn.dataset.token
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Erreur lors de la modification');
                    }

                    const data = await response.json();
                    
                    // Mettre à jour le contenu et la date
                    commentContent.textContent = data.content;
                    updateDateTime(commentContainer, data.createdAt);
                    
                    editForm.remove();
                    commentContent.style.display = '';
                    
                    // Réafficher les boutons d'action après l'édition
                    if (actionsDiv) {
                        actionsDiv.style.display = 'inline-flex';
                    }
                    
                    showAlert('Commentaire modifié avec succès', 'success', commentContainer.closest('.modal-body'));

                } catch (error) {
                    showAlert(error.message, 'danger', commentContainer.closest('.modal-body'));
                    // Réafficher les boutons d'action en cas d'erreur
                    if (actionsDiv) {
                        actionsDiv.style.display = 'inline-flex';
                    }
                } finally {
                    submitBtn.disabled = false;
                }
            });
        });
    }
    
    // Fonction pour attacher les événements au formulaire de suppression
    function attachDeleteFormEvents(form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const modalBody = this.closest('.modal-body');
            const postId = this.dataset.postId;
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Erreur lors de la suppression');
                }

                // Supprimer le commentaire du DOM
                const commentElement = this.closest('.d-flex.align-items-start.mb-3');
                if (commentElement) {
                    commentElement.remove();
                }

                // Mettre à jour le compteur de commentaires
                updateCommentCount(postId);

                showAlert(data.message, 'success', modalBody);

            } catch (error) {
                showAlert(error.message, 'danger', modalBody);
            } finally {
                submitBtn.disabled = false;
            }
        });
    }
    
    // Attacher les événements aux boutons d'édition existants
    document.querySelectorAll('.js-edit-comment-btn').forEach(btn => {
        attachEditButtonEvents(btn);
    });
    
    // Attacher les événements aux formulaires de suppression existants
    document.querySelectorAll('.js-delete-comment-form').forEach(form => {
        attachDeleteFormEvents(form);
    });

    // Fonction pour mettre à jour le compteur de commentaires
    function updateCommentCount(postId) {
        const commentButton = document.querySelector(`[data-bs-target="#commentsModal${postId}"]`);
        if (commentButton) {
            const count = document.querySelectorAll(`#commentsModal${postId} .d-flex.align-items-start.mb-3`).length;
            const commentSpan = commentButton.querySelector('.comment-count');
            if (commentSpan) {
                commentSpan.textContent = `${count}`;
            }
        }
    }

    // Définir les types de réactions globalement
    const REACTION_TYPES = JSON.parse('{{ reactionTypes|json_encode|raw }}');
    
    // Gestion des réactions
    document.querySelectorAll('.post-buttons-container').forEach(container => {
        const btn = container.querySelector('.btn-react-toggle');
        const bar = container.querySelector('.reaction-bar');
        let timeoutId;

        // Gestion du survol pour afficher/masquer la barre de réactions
        const showReactionBar = () => {
            clearTimeout(timeoutId);
            bar.style.left = btn.offsetLeft + (btn.offsetWidth / 2) + 'px';
            bar.classList.remove('d-none');
        };

        const hideReactionBar = () => {
            timeoutId = setTimeout(() => {
                bar.classList.add('d-none');
            }, 300);
        };

        btn.addEventListener('mouseenter', showReactionBar);
        btn.addEventListener('mouseleave', hideReactionBar);
        bar.addEventListener('mouseenter', () => clearTimeout(timeoutId));
        bar.addEventListener('mouseleave', hideReactionBar);

        // Fonction pour mettre à jour l'affichage des réactions
        const updateReactionDisplay = (postId, data) => {
            const button = document.querySelector(`.btn-react-toggle[data-post-id="${postId}"]`);
            if (!button) return;
            
            // Calculer le total des réactions
            let total = 0;
            Object.values(data.counts).forEach(count => {
                total += count;
            });
            
            // Mise à jour du bouton de réaction
            if (data.userReaction) {
                button.innerHTML = `
                    <span class="reaction-${data.userReaction}">
                        ${REACTION_TYPES[data.userReaction]}
                    </span>
                    <span class="reaction-count ms-1">${total}</span>
                `;
                button.classList.add('active');
            } else {
                button.innerHTML = `
                    <i class="far fa-thumbs-up"></i>
                    <span class="reaction-count ms-1">${total}</span>
                `;
                button.classList.remove('active');
            }
        };

        // Gestion des clics sur les réactions
        bar.querySelectorAll('.react-option').forEach(option => {
            option.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const type = option.dataset.type;
                const postId = btn.dataset.postId;
                const csrfToken = btn.dataset.csrfToken;

                try {
                    const response = await fetch(`/reaction/${postId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: new URLSearchParams({ type })
                    });

                    if (!response.ok) throw new Error('Erreur réseau');
                    
                    const data = await response.json();
                    updateReactionDisplay(postId, data);
                    
                } catch (error) {
                    console.error('Erreur:', error);
                }

                hideReactionBar();
            });
        });

        // Gestion du clic sur le bouton principal de réaction
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const postId = btn.dataset.postId;
            const csrfToken = btn.dataset.csrfToken;
            const currentReaction = btn.querySelector('.reaction-like, .reaction-love, .reaction-haha, .reaction-wow, .reaction-sad, .reaction-angry');
            
            // Si déjà une réaction, on utilise le même type pour la supprimer
            const type = currentReaction ? currentReaction.className.split('-')[1] : 'like';

            try {
                const response = await fetch(`/reaction/${postId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: new URLSearchParams({ type })
                });

                if (!response.ok) throw new Error('Erreur réseau');
                
                const data = await response.json();
                updateReactionDisplay(postId, data);
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        });
    });

    // Gestion de la suppression des posts
    document.querySelectorAll('.js-delete-post-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const postId = form.action.match(/\/post\/(\d+)$/)[1];
            const submitBtn = this.querySelector('button[type="submit"]');
            const modal = this.closest('.modal');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Suppression...';
            
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this)
                });
                
                if (response.redirected) {
                    // Succès : redirection vers la page index
                    window.location.href = response.url;
                } else {
                    // Échec : afficher une erreur
                    const data = await response.text();
                    throw new Error('Échec de la suppression');
                }
            } catch (error) {
                alert(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Supprimer';
                
                // Fermer le modal en cas d'erreur
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                }
            }
        });
    });

    // Fonction pour attacher les événements au formulaire d'ajout de commentaire
    function attachAddCommentFormEvents(form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const modalBody = this.closest('.modal-body');
            const postId = this.dataset.postId;
            const submitBtn = this.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById(`comment-errors-${postId}`);
            submitBtn.disabled = true;

            try {
                const formData = new FormData(this);
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de l\'ajout du commentaire');
                }

                // Créer et ajouter le nouveau commentaire
                const commentElement = createCommentElement(data, postId);
                const commentsList = this.closest('.modal-body').querySelector('.comments-list');
                commentsList.insertBefore(commentElement, commentsList.firstChild);
                
                // Réinitialiser le formulaire
                this.reset();
                
                // Mettre à jour le compteur de commentaires
                updateCommentCount(postId);
                
                showAlert('Commentaire ajouté avec succès', 'success', modalBody);

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                showAlert(error.message, 'danger', modalBody);
            } finally {
                submitBtn.disabled = false;
            }
        });
    }
});
</script>
{% endblock %}
