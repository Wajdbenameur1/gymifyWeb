{% extends 'sportifdashboard/homepagesportif.html.twig' %}

{% block title %}Tous les articles{% endblock %}

{% block body_attrs %}
  {{ parent() }}
  data-user-id="{{ app.user ? app.user.id : '' }}"
{% endblock %}

{% block stylesheet %}
<link rel="stylesheet" href="{{ asset('css/post-style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    /* Facebook-like mention styling */
    .user-mention {
      color: #00CED1 !important; /* Turquoise blue */
      font-weight: 500 !important;
      background-color: rgba(0, 206, 209, 0.1) !important;
      padding: 0 3px !important;
      border-radius: 4px !important;
      text-decoration: none !important;
      display: inline-block !important;
    }
    
    .user-mention:hover {
      text-decoration: underline !important;
      background-color: rgba(0, 206, 209, 0.2) !important;
      cursor: pointer !important;
    }

    .comment-actions {
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.2s ease;
        display: inline-flex !important;
        gap: 12px;
        align-items: center;
        position: absolute !important;
        right: 10px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        z-index: 100 !important;
    }

    .comment-container:hover .comment-actions {
        opacity: 1 !important;
    }

    .btn-icon {
        padding: 8px !important;
        border-radius: 50% !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
        border: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        width: 36px !important;
        height: 36px !important;
    }

    .btn-icon:hover {
        transform: translateY(-3px) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.25) !important;
    }

    /* Couleurs et styles pour les icônes */
    .btn-icon.edit {
        background-color: #2196F3 !important;
    }
    
    .btn-icon.edit i {
        color: white !important;
        font-size: 1rem !important;
    }

    .btn-icon.delete {
        background-color: #dc3545 !important;
    }

    .btn-icon.delete i {
        color: white !important;
        font-size: 1rem !important;
    }

    /* Effets de survol améliorés */
    .btn-icon.edit:hover {
        background-color: #0d8bf2 !important;
    }

    .btn-icon.delete:hover {
        background-color: #c82333 !important;
    }

    /* Style pour les tooltips */
    [data-tooltip] {
        position: relative !important;
    }

    [data-tooltip]:before {
        content: attr(data-tooltip);
        position: absolute !important;
        bottom: 120% !important;
        left: 50% !important;
        transform: translateX(-50%) translateY(-5px) !important;
        padding: 6px 12px !important;
        background: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        font-size: 12px !important;
        font-weight: 500 !important;
        white-space: nowrap !important;
        border-radius: 4px !important;
        opacity: 0 !important;
        visibility: hidden !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
        z-index: 100 !important;
    }

    [data-tooltip]:hover:before {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateX(-50%) translateY(-10px) !important;
    }
    
    /* Style pour les boutons d'action du post */
    .post-buttons-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 10px;
        width: 100%;
    }
    
    .btn-post-action {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 16px;
        transition: all 0.2s ease;
        flex: 1;
        min-width: fit-content;
        max-width: 110px;
    }
    
    .btn-post-action i {
        margin-right: 0;
        font-size: 18px;
    }
    
    .btn-post-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Styles pour Responsive */
    @media (max-width: 576px) {
        .btn-post-action {
            padding: 6px 10px;
            font-size: 14px;
        }
        
        .btn-post-action i {
            font-size: 16px;
        }
    }
</style>
{% endblock %}

{% block body %}
<nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ path('app_post_index') }}">Blogs</a></li>
    <li class="breadcrumb-item active" aria-current="page">Home</li>
  </ol>
</nav>

<h1 class="mb-4">{{ 'blog.all_blogs'|trans }}</h1>
<a href="{{ path('app_post_new') }}" class="btn btn-success btn-rounded">{{ 'blog.create_new'|trans }}</a>
<br><br>
<div class="container">
  <div class="row">
    {% for post in posts %}
      <div class="col-12 col-md-6 mb-4">
        <div class="card card-post card-round h-100">
          {% if post.imageUrl %}
            <img class="card-img-top" src="{{ asset(post.webPath) }}" alt="Image du post {{ post.title }}" />
          {% endif %}
          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-center mb-2">
              <img src="{{ post.user.imageUrl ? asset(post.user.imageUrl) : asset('img/screen/user.png') }}" alt="Avatar de {{ post.user.nom }}" class="avatar-img rounded-circle" style="width:40px; height:40px; object-fit:cover;">
              <div class="ms-2">
                <p class="username mb-0">{{ post.user.nom }}</p>
                <p class="date text-muted mb-0">{{ post.createdAt ? post.createdAt|date('d M Y') : '—' }}</p>
              </div>
            </div>
            <div class="separator-solid mb-2"></div>
            <h5 class="card-title">
              <a href="{{ path('app_post_show',{id:post.id}) }}">{{ post.title }}</a>
            </h5>
            <p class="card-text flex-grow-1">{{ post.content|raw }}</p>
            <div class="mt-auto">
              <a href="{{ path('app_post_show',{id:post.id}) }}" class="btn btn-primary">{{ 'blog.show'|trans }}</a>
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#commentsModal{{ post.id }}">{{ post.comments|length }} {{ 'blog.comments'|trans }}</button>
              {% if post.user == app.user %}
                <a href="{{ path('app_post_edit',{id:post.id}) }}" class="btn btn-secondary ms-2">{{ 'blog.edit'|trans }}</a>
                <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deletePostModal{{ post.id }}">{{ 'blog.delete'|trans }}</button>
              {% endif %}
            </div>
          </div>
        </div>

        {# Modal commentaires #}
        <div class="modal fade" id="commentsModal{{ post.id }}" tabindex="-1" aria-labelledby="commentsModalLabel{{ post.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content" style="border-radius:10px;overflow:hidden;">
              <div class="modal-body p-0 d-flex" style="height:80vh;">

                <div class="col-md-7 d-none d-md-block bg-dark">
                  {% if post.imageUrl %}
                    <img src="{{ asset(post.webPath) }}" class="w-100 h-100" style="object-fit:cover;" alt="Post image">
                  {% else %}
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center text-white">Pas d'image</div>
                  {% endif %}
                </div>

                <div class="col-md-5 d-flex flex-column bg-white">

                  <div class="d-flex align-items-center p-3 border-bottom">
                    <img src="{{ post.user.imageUrl ? asset(post.user.imageUrl) : asset('img/screen/user.png') }}" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover;">
                    <strong>{{ post.user.nom }}</strong>
                  </div>
                  <div class="p-3 border-bottom">
                    <h5>{{ post.title }}</h5>
                    <p class="mb-1">{{ post.content|raw }}</p>
                    <small class="text-muted">{{ post.createdAt ? post.createdAt|date('d M Y à H:i') : '—' }}</small>
                  </div>
                  <div class="flex-grow-1 overflow-auto p-3" style="min-height:0;">
                    {% for comment in post.comments %}
                      <div class="d-flex align-items-start mb-3">
                        <img src="{{ comment.user.imageUrl ? asset(comment.user.imageUrl) : asset('img/screen/user.png') }}" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover;">
                        <div class="w-100">
                          <strong>{{ comment.user.nom }}</strong>
                          <p class="mb-1">{{ comment.content }}</p>
                          <small class="text-muted">{{ comment.createdAt|date('d M Y à H:i') }}</small>
                          {% if comment.user == app.user %}
                            <div class="mt-1">
                              <a href="{{ path('app_comment_edit',{id:comment.id}) }}" class="btn btn-sm btn-link p-0 me-2">{{ 'blog.edit'|trans }}</a>
                              <form action="{{ path('app_comment_delete',{id:comment.id}) }}" method="post" class="js-delete-comment-form d-inline" data-post-id="{{ post.id }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comment.id) }}">
                                <button type="submit" class="btn btn-sm btn-danger">{{ 'blog.delete'|trans }}</button>
                              </form>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    {% else %}
                      <p class="text-center text-muted">{{ 'blog.no_comments'|trans }}</p>
                    {% endfor %}
                  </div>
                  <div class="border-top p-3 d-flex align-items-center">
                    <img src="{{ app.user.imageUrl ? asset(app.user.imageUrl) : asset('img/screen/user.png') }}" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover;">
                   
                   
                    <div id="comment-errors-{{ post.id }}" class="text-danger mb-2" style="display: none;"></div>

                    <form 
                        action="{{ path('app_comment_new',{postId:post.id}) }}" 
                        method="post" 
                        class="js-add-comment-form w-100 d-flex" 
                        data-post-id="{{ post.id }}"
                    >
                        {# champ CSRF obligatoire #}
                        <input type="hidden" name="_token" 
                               value="{{ csrf_token('comment' ~ post.id) }}">
                        <input 
                            type="text" 
                            name="content" 
                            class="form-control me-2 border-0 bg-light" 
                            placeholder="{{ 'blog.add_comment'|trans }}" 
                            required
                        >
                        <button type="submit" class="btn btn-primary">
                            {{ 'blog.add'|trans }}
                        </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# Modal de suppression du post #}
        <div class="modal fade" id="deletePostModal{{ post.id }}" tabindex="-1" aria-labelledby="deletePostModalLabel{{ post.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="deletePostModalLabel{{ post.id }}">{{ 'blog.delete_post_confirmation'|trans }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {{ 'blog.delete_post_warning'|trans }}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'blog.cancel'|trans }}</button>
                <form action="{{ path('app_post_delete', {'id': post.id}) }}" method="post">
                  <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ post.id) }}">
                  <button type="submit" class="btn btn-danger">{{ 'blog.confirm_delete'|trans }}</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="col-12">
        <div class="alert alert-info">
          {{ 'blog.no_posts_found'|trans }}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Gestion des formulaires de commentaires via AJAX
    document.querySelectorAll('.js-add-comment-form').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const postId = this.getAttribute('data-post-id');
        const errorContainer = document.getElementById(`comment-errors-${postId}`);
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Recharger la page pour afficher le nouveau commentaire
            window.location.reload();
          } else {
            // Afficher les erreurs
            errorContainer.textContent = data.error || 'Une erreur est survenue.';
            errorContainer.style.display = 'block';
          }
        })
        .catch(error => {
          errorContainer.textContent = 'Une erreur est survenue lors de l\'envoi du commentaire.';
          errorContainer.style.display = 'block';
        });
      });
    });
    
    // Gestion des suppressions de commentaires via AJAX
    document.querySelectorAll('.js-delete-comment-form').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const postId = this.getAttribute('data-post-id');
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Recharger la page pour mettre à jour la liste des commentaires
            window.location.reload();
          } else {
            alert('Une erreur est survenue lors de la suppression du commentaire.');
          }
        })
        .catch(error => {
          alert('Une erreur est survenue lors de la connexion au serveur.');
        });
      });
    });
  });
</script>
{% endblock %}
