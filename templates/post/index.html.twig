{% extends 'sportifdashboard/homepagesportif.html.twig' %}

{% block title %}Post index{% endblock %}

{% block stylesheet %}
<link rel="stylesheet" href="{{ asset('css/post-style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

{% endblock %}

{% block body %}


<nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">Blogs</li>
    <li class="breadcrumb-item active" aria-current="page"><a href="#">Home</a></li>
  </ol>
</nav>


<h1 class="mb-4">Posts</h1>

<a href="{{ path('app_post_new') }}" class="btn btn-success btn-rounded">
  Create new post
</a>
<br> <br>
<div class="container">
  <div class="row">
    {% for post in posts %}
      <div class="col-12 col-md-6 mb-4">
        <div class="card card-post card-round h-100">
          {# Image du post s’il y en a #}
          {% if post.imageUrl %}
            <img 
              class="card-img-top" 
              src="{{ asset(post.webPath) }}" 
              alt="Image du post {{ post.title }}"
            />
          {% endif %}

          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-center mb-2">
              {# Avatar de l’utilisateur #}
              <div class="avatar">
                <img
                  src="{{ post.user.imageUrl
                           ? asset(post.user.imageUrl)
                           : asset('img/screen/user.png') }}"
                  alt="Avatar de {{ post.user.nom }}"
                  class="avatar-img rounded-circle"
                />
              </div>
              <div class="info-post ms-2">
                <p class="username mb-0">{{ post.user.nom }}</p>
                <p class="date text-muted mb-0">
                  {{ post.createdAt ? post.createdAt|date('d M Y') : '—' }}
                </p>
              </div>
            </div>

            <div class="separator-solid mb-2"></div>

            <p class="card-category text-info mb-1">
              <a href="#">new</a>
            </p>

            <h5 class="card-title">
              <a href="{{ path('app_post_show', { id: post.id }) }}">
                {{ post.title }}
              </a>
            </h5>

            <p class="card-text flex-grow-1">
              {# Affichage du contenu avec HTML rendu #}
              {{ post.content|raw }} {# Assurez-vous que post.content est bien stocké comme du HTML valide #}
            </p>

            <div class="mt-auto">
              <a href="{{ path('app_post_show', { id: post.id }) }}" class="btn btn-primary">
                  Show
              </a>
          
              <button 
                  type="button" 
                  class="btn btn-primary" 
                  data-bs-toggle="modal" 
                  data-bs-target="#commentsModal{{ post.id }}">
                  {{ post.comments|length }} Commentaires
              </button>





















             <!-- Modal Bootstrap pour les commentaires version Instagram -->
             <div class="modal fade" id="commentsModal{{ post.id }}" tabindex="-1" aria-labelledby="commentsModalLabel{{ post.id }}" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content" style="border-radius: 10px; overflow: hidden;">
                  <div class="modal-body p-0 d-flex" style="height: 80vh;">
                    
                    <!-- Colonne gauche : Image du post -->
                    <div class="col-md-7 d-none d-md-block bg-dark">
                      {% if post.imageUrl %}
                      <img src="{{ asset(post.webPath) }}" class="w-100 h-100" style="object-fit: cover;" alt="Post image">
                      {% else %}
                        <div class="w-100 h-100 d-flex align-items-center justify-content-center text-white">
                          Pas d'image
                        </div>
                      {% endif %}
                    </div>
            
                    <!-- Colonne droite : Commentaires -->
                    <div class="col-md-5 d-flex flex-column bg-white">
                      
                      <!-- Header -->
                      <div class="d-flex align-items-center p-3 border-bottom">
                        <img 
                          src="{{ post.user.imageUrl ? asset(post.user.imageUrl) : asset('img/screen/user.png') }}" 
                          class="rounded-circle me-2" 
                          style="width: 32px; height: 32px; object-fit: cover;"
                        >
                        <strong>{{ post.user.nom }}</strong>
                      </div>
            
                      <!-- Commentaires -->
                      <div class="flex-grow-1 p-3 overflow-auto" style="min-height: 0;">
                        {% for comment in post.comments %}
                          <div class="d-flex align-items-start mb-3">
                            <img 
                              src="{{ comment.user.imageUrl ? asset(comment.user.imageUrl) : asset('img/screen/user.png') }}" 
                              alt="Avatar" 
                              class="rounded-circle me-2" 
                              style="width: 32px; height: 32px; object-fit: cover;"
                            >
                            <div>
                              <strong>{{ comment.user.nom }}</strong>
                              <p class="mb-1">{{ comment.content }}</p>
                              <small class="text-muted">{{ comment.createdAt|date('d M Y à H:i') }}</small>
                            </div>
                          </div>
                        {% else %}
                          <p class="text-center text-muted">Aucun commentaire pour ce post.</p>
                        {% endfor %}
                      </div>
            
                      <!-- Formulaire ajout -->
                      <div class="border-top p-3">
                        <div id="comment-errors-{{ post.id }}" class="text-danger" style="display: none;"></div>


                        <form 
                          action="{{ path('app_comment_new', { postId: post.id }) }}" 
                          method="POST" 
                          class="d-flex align-items-center"
                          data-post-id="{{ post.id }}"  <!-- Ajouter cet attribut -->

                        >
                          <img 
                            src="{{ app.user.imageUrl ? asset(app.user.imageUrl) : asset('img/screen/user.png') }}" 
                            alt="Votre avatar" 
                            class="rounded-circle me-2" 
                            style="width: 32px; height: 32px; object-fit: cover;"
                          >
                          <input 
                            type="text" 
                            name="content" 
                            class="form-control me-2 border-0 bg-light" 
                            placeholder="Ajouter un commentaire..." 
                            required
                          >
                          <button type="submit" class="btn btn-primary">Publier</button>
                        </form>
                      </div>
            
                    </div>
                  </div>
                </div>
              </div>
            </div>
            












              
              {% if post.user == app.user %}
  <a 
    href="{{ path('app_post_edit', { id: post.id }) }}" 
    class="btn btn-secondary"
  >Edit</a>
































 <!-- Bouton pour déclencher le modal -->
<button 
class="btn btn-danger ms-2" 
data-bs-toggle="modal" 
data-bs-target="#deleteModal{{ post.id }}"
>
Delete
</button>

<!-- Modal Bootstrap DELETe-->
<div 
  class="modal fade" 
  id="deleteModal{{ post.id }}" 
  tabindex="-1" 
  aria-labelledby="deleteModalLabel{{ post.id }}" 
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      
      <div class="modal-header justify-content-center border-0">
        <h5 class="modal-title w-100" id="deleteModalLabel{{ post.id }}">
          <i class="fas fa-trash-alt fa-3x text-danger"></i>
        </h5>
      </div>

      <div class="modal-body">
        <p class="mb-2">
          Es-tu sûr(e) de vouloir supprimer ce post :
        </p>
        <p><strong>{{ post.title }}</strong> ?</p>
      </div>

      <div class="modal-footer justify-content-center">
        <button 
          type="button" 
          class="btn btn-secondary" 
          data-bs-dismiss="modal"
        >
          Annuler
        </button>















        <form 
          method="post" 
          action="{{ path('app_post_delete', { id: post.id }) }}"
          class="d-inline"
        >
          <input 
            type="hidden" 
            name="_token" 
            value="{{ csrf_token('delete' ~ post.id) }}"
          >
          <button type="submit" class="btn btn-danger">
            Supprimer
          </button>
        </form>
      </div>
      
    </div>
  </div>
</div>











{% endif %}




            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="col-12">
        <p class="text-center">Aucun post trouvé.</p>
      </div>
    {% endfor %}
  </div>
</div>


{% endblock %} 






{% block javascripts %}
    {{ parent() }}
    <script>
        // Écouter tous les formulaires de commentaire sur la page
        document.querySelectorAll('form').forEach(function(form) {
          form.addEventListener('submit', function(e) {
              e.preventDefault();  // Empêche l'envoi classique du formulaire
      
              var formData = new FormData(this);
              var postId = this.dataset.postId;  // Récupérer l'ID du post depuis un attribut data-post-id
      
              // Désactiver le bouton de soumission pour éviter les soumissions multiples
              var submitButton = this.querySelector('button[type="submit"]');
              submitButton.disabled = true;
              submitButton.innerText = "Envoi en cours...";  // Optionnel : Changer le texte du bouton
      
              // Envoi de la requête AJAX
              fetch("{{ path('app_comment_new', { postId: '__postId__' }) }}".replace('__postId__', postId), {
                  method: "POST",
                  body: formData,
              })
              .then(response => response.json())
              .then(data => {
                  if (data.errors) {
                      // Si des erreurs sont retournées, afficher les erreurs
                      var errorDiv = document.getElementById("comment-errors-" + postId);
                      errorDiv.innerHTML = data.errors.join('<br>');
                      errorDiv.style.display = 'block';  // Afficher les erreurs
                  } else {
                      // Si aucune erreur, on peut rafraîchir ou ajouter dynamiquement le commentaire
                      location.reload();  // Recharger la page ou ajouter dynamiquement le commentaire
                  }
              })
              .catch(error => {
                  console.error("Erreur lors de l'ajout du commentaire:", error);
              })
              .finally(() => {
                  // Réactiver le bouton après la soumission (en cas d'erreur ou succès)
                  submitButton.disabled = false;
                  submitButton.innerText = "Publier";  // Optionnel : Restaurer le texte du bouton
              });
          });
      });
      
    </script>
{% endblock %}






